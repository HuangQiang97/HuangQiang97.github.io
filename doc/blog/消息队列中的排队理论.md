## æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿç†è®º

[toc]

#### 1ï¼Œå•é˜Ÿåˆ—å•æ¶ˆè´¹è€…

* MQä¸­é»˜è®¤ä¸€ä¸ªé˜Ÿåˆ—åªå¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå‡è®¾å•ä½æ—¶é—´å†…æ–°æ¥$\lambda$ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å•ä½æ—¶é—´å¯ä»¥å¤„ç†$\mu$æ¡æ¶ˆæ¯ï¼Œä¸èƒ½åŠæ—¶è¢«æ¶ˆè´¹çš„æ¶ˆæ¯å°†ç¼“å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸Šè¿°ç³»ç»Ÿå¯ä»¥å»ºæ¨¡ä¸ºä¸€ä¸ª`M/M/1`ç³»ç»Ÿ[^1]ã€‚

* é˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„åˆ°è¾¾å’Œæ¶ˆè´¹å¯ä»¥å»ºæ¨¡ä¸ºç”Ÿç­è¿‡ç¨‹[^2]ï¼Œå‡è®¾æœ‰$k$æ¡å¾…å¤„ç†æ¶ˆæ¯çš„çŠ¶æ€ä¸º$S_k$ï¼Œå¤„äºè¯¥çŠ¶æ€çš„æ¦‚ç‡ä¸º$P_k$ã€‚

    <img src=".\assets\image-20240514223614793.png" alt="image-20240514223614793" style="zoom:40%;" />

* $S_k$å¯èƒ½å› ä¸ºæœ‰æ–°æ¶ˆæ¯åˆ°è¾¾è½¬ç§»åˆ°$S_{k+1}$ï¼Œæˆ–è€…ç°æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹è½¬ç§»åˆ°$S_{k-1}$ï¼Œä»–ä»¬çš„è½¬ç§»é€Ÿç‡å¯ä»¥å®šä¹‰ä¸º$P_k\lambda, P_{k}\mu$ï¼ŒäºŒè€…ä¹‹å’Œå®šä¹‰ä¸ºæµå‡ºçŠ¶æ€$S_k$çš„é€Ÿç‡ã€‚

* $S_k$ä¹Ÿå¯ä»¥é€šè¿‡åœ¨$S_{k-1}$æ—¶æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ï¼Œæˆ–è€…åœ¨çŠ¶æ€$S_{k+1}$æ—¶ç°æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹è½¬ç§»å¾—åˆ°ã€‚ä»–ä»¬è½¬ç§»çš„é€Ÿç‡å¯ä»¥å®šä¹‰ä¸º$P_{k-1}\lambda, P_{k+1}\mu$ï¼ŒäºŒè€…ä¹‹å’Œå®šä¹‰ä¸ºæµå…¥çŠ¶æ€$S_k$çš„é€Ÿç‡ã€‚

* å¦‚æœé˜Ÿåˆ—åœ¨çŠ¶æ€$S_k$è¾¾åˆ°å¹³è¡¡ï¼Œåˆ™æµå…¥çŠ¶æ€$S_k$çš„é€Ÿç‡ç­‰äºæµå‡ºçŠ¶æ€$S_k$çš„é€Ÿç‡ï¼Œ
  
    å¯¹äº$k=0$æ—¶æœ‰
    $$
    P_{0}\lambda=P_{1}\mu
    $$
    
    
    å¯¹äº$k>0$æœ‰
    $$
    P_k\lambda+P_{k}\mu=P_{k-1}\lambda+ P_{k+1}\mu
    $$
    ç»“åˆä¸Šè¿°ä¸¤å¼å¯ä»¥è·å¾—
    $$
    P_k=P_{k-1}\frac{\lambda}{\mu}, k>0
    $$
    é˜Ÿåˆ—å…¨éƒ¨çŠ¶æ€çš„æ¦‚ç‡å’Œä¸ºä¸€$\sum_{k=0}^{\infty}P_k=1$ï¼Œé€šè¿‡å¯¹$P_k$è¿›è¡Œç­‰æ¯”æ•°åˆ—æ±‚å’Œæ±‚è§£å¾—åˆ°
    $$
    P_k=(1-\frac{\lambda}{\mu})(\frac{\lambda}{\mu})^k
    $$
    
* ç³»ç»Ÿæ¶ˆæ¯æ€»æ•°å‡å€¼ä¸ºå¤„äºå„ä¸ªçŠ¶æ€çš„æ¦‚ç‡å’Œï¼š$L=\sum_{k=0}^\infty kP_k=\sum_{k=0}^\infty k(1-\frac{\lambda}{\mu})(\frac{\lambda}{\mu})^k=\frac{\lambda}{\mu-\lambda}$

* ç­‰å¾…æ¶ˆæ¯æ€»æ•°å‡å€¼ä¸ºç³»ç»Ÿæ¶ˆæ¯æ€»æ•°å‡å€¼å‡å»æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯æ•°ï¼š$L_q=L-\frac{\lambda}{\mu}=\frac{\lambda}{\mu-\lambda}-\frac{\lambda}{\mu}$

* åº”ç”¨`Little Law`[^3]è·å¾—æ¶ˆæ¯åœ¨ç³»ç»Ÿçš„å¹³å‡é€—ç•™æ—¶é—´ï¼š $W=\frac{L}{\lambda }=\frac{1}{\muâˆ’\lambda}$

* åº”ç”¨`Little Law`è·å¾—æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å¹³å‡ç­‰å¾…æ—¶é—´ï¼š$ ğ‘Š_q=\frac{L_ğ‘}{\lambda}=\frac{\lambda}{\mu(\mu-\lambda)}$

#### 2ï¼Œå•é˜Ÿåˆ—å¤šæ¶ˆè´¹è€…

* MQå¼€å¯æ‰¹é‡æ¶ˆè´¹ï¼Œä¸€ä¸ªé˜Ÿåˆ—å¯¹åº”`n`ä¸ªæ¶ˆè´¹è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±äº«åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‡è®¾å•ä½æ—¶é—´å†…æ–°åˆ°è¾¾$\lambda$ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…å•ä½æ—¶é—´æœ€å¤šå¯ä»¥å¤„ç†$\mu$æ¡æ¶ˆæ¯ï¼Œä¸èƒ½åŠæ—¶è¢«æ¶ˆè´¹çš„æ¶ˆæ¯å°†ç¼“å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸Šè¿°ç³»ç»Ÿå¯ä»¥å»ºæ¨¡ä¸ºä¸€ä¸ª`M/M/n`ç³»ç»Ÿ[^4]ã€‚

    <img src=".\assets\image-20240514223653294.png" alt="image-20240514223653294" style="zoom:40%;" />

* $S_k$å¯èƒ½å› ä¸ºæœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ä»è€Œè½¬ç§»åˆ°$S_{k+1}$ï¼Œæˆ–è€…ç°æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹è½¬ç§»åˆ°çŠ¶æ€$S_{k-1}$ã€‚

    å¦‚æœé˜Ÿåˆ—æ¶ˆæ¯æ•°å°äºæ¶ˆè´¹è€…æ•°$k<n$ï¼Œåˆ™ä»–ä»¬è½¬ç§»çš„é€Ÿç‡å¯ä»¥åˆ†åˆ«å®šä¹‰ä¸º$P_k\lambda, kP_{k}\mu$ï¼›å¦‚æœé˜Ÿåˆ—æ¶ˆæ¯æ•°å¤§äºç­‰äºæ¶ˆè´¹è€…æ•°$k>=n$ï¼Œåˆ™ä»–ä»¬è½¬ç§»çš„é€Ÿç‡å¯ä»¥å®šä¹‰ä¸º$P_k\lambda, nP_{k}\mu$ï¼ŒäºŒè€…ä¹‹å’Œå®šä¹‰ä¸ºæµå‡ºçŠ¶æ€$S_k$çš„é€Ÿç‡ã€‚

* $S_k$å¯ä»¥é€šè¿‡åœ¨$S_{k-1}$æ—¶æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ï¼Œæˆ–è€…åœ¨çŠ¶æ€$S_{k+1}$æ—¶ç°æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹è½¬ç§»å¾—åˆ°ã€‚

    å¦‚æœé˜Ÿåˆ—æ¶ˆæ¯æ•°å°äºæ¶ˆè´¹è€…$k<n$ï¼Œåˆ™ä»–ä»¬è½¬ç§»çš„é€Ÿç‡å¯ä»¥å®šä¹‰ä¸º$P_{k-1}\lambda, (k+1)P_{k+1}\mu$ï¼›å¦‚æœé˜Ÿåˆ—æ¶ˆæ¯æ•°å¤§äºç­‰äºæ¶ˆè´¹è€…æ•°$k>=n$ï¼Œåˆ™ä»–ä»¬è½¬ç§»çš„é€Ÿç‡å¯ä»¥å®šä¹‰ä¸º$P_{k-1}\lambda, nP_{k+1}\mu$ï¼ŒäºŒè€…ä¹‹å’Œå®šä¹‰ä¸ºæµå…¥çŠ¶æ€$S_k$çš„é€Ÿç‡ã€‚

* å¦‚æœé˜Ÿåˆ—åœ¨çŠ¶æ€$S_k$æ—¶åˆ°è¾¾å¹³è¡¡ï¼Œåˆ™æµå…¥çŠ¶æ€$S_k$çš„é€Ÿç‡ç­‰äºæµå‡ºçŠ¶æ€$S_k$çš„é€Ÿç‡ï¼Œ

    å¯¹äº$k=0$æœ‰
    $$
    P_{0}\lambda=P_{1}\mu
    $$
    å¯¹äº$k<n$æœ‰
    $$
    P_k\lambda+kP_{k}\mu=P_{k-1}\lambda+ (k+1)P_{k+1}\mu
    $$
    å¯¹äº$k\geq n$æœ‰
    $$
    P_k\lambda+nP_{k}\mu=P_{k-1}\lambda+ nP_{k+1}\mu
    $$
    ç»¼åˆä¸Šå¼é€’æ¨å¾—åˆ°ç³»ç»Ÿç©ºé—²æ¦‚ç‡$P_0$ï¼Œä»¥åŠç³»ç»ŸåŒ…å«$k$æ¡æ¶ˆæ¯çš„æ¦‚ç‡ä¸º
    $$
    \begin{array}{ll}
    P_0 = \left( \sum_{k=0}^{n-1} \frac{(\lambda / \mu)^k}{k!} + \frac{(\lambda / \mu)^n}{n! \cdot (1 - \rho)} \right)^{-1}\\
    P_k = \frac{(\lambda / \mu)^k}{k!}  P_0& k < n\\
    P_k = \frac{(\lambda / \mu)^k}{n^{k-n} \cdot n!}  P_0 &k \geq n
    \end{array}
    $$

* åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†çš„æ¶ˆæ¯æ€»æ•°å‡å€¼ä¸ºï¼š$L_q = \frac{(n \lambda/\mu)^n}{n! \left(1 - \frac{\lambda}{n\mu}\right)^2} P_0$

* ç³»ç»Ÿå¹³å‡æ¶ˆæ¯æ€»æ•°å‡å€¼ä¸ºå¤„äºç­‰å¾…çŠ¶æ€çš„æ¶ˆæ¯æ€»æ•°å‡å€¼åŠ ä¸Šæ­£åœ¨å¤„ç†çš„æ¶ˆæ¯æ€»æ•°å‡å€¼ï¼š$L = L_q + n \lambda/\mu$

* åº”ç”¨`Little Law`è·å¾—æ¶ˆæ¯åœ¨ç³»ç»Ÿçš„å¹³å‡é€—ç•™æ—¶é—´å‡å€¼ï¼š $W = \frac{L}{\lambda}$

* åº”ç”¨`Little Law`è·å¾—æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å¹³å‡ç­‰å¾…å‡å€¼æ—¶é—´ï¼š$W_q = \frac{L_q}{\lambda}$

#### 3ï¼Œæ€§èƒ½å¯¹æ¯”

* ç°åœ¨å‡è®¾æœ‰5ä¸ªæ¶ˆè´¹è€…`n=5`ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…å•ä½æ—¶é—´å†…å¯ä»¥å¤„ç†ä¸€æ¡æ¶ˆæ¯$\mu=1$ã€‚å¯¹äºå•é˜Ÿåˆ—å•æ¶ˆè´¹è€…æƒ…å½¢æ„å»ºnä¸ªç‹¬ç«‹çš„é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å…³è”ä¸€ä¸ªæ¶ˆè´¹è€…ï¼›å¯¹äºå•é˜Ÿåˆ—å¤šæ¶ˆè´¹è€…æƒ…å½¢ï¼Œç³»ç»Ÿåªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œnä¸ªæ¶ˆè´¹è€…å…±äº«è¯¥é˜Ÿåˆ—ã€‚

* å¯¹äºnä¸ªå•é˜Ÿåˆ—å•æ¶ˆè´¹è€…æ„æˆçš„ç³»ç»Ÿï¼Œå®šä¹‰ç³»ç»Ÿè´Ÿè½½$\rho=\frac{n\lambda}{n\mu}=\frac{\lambda}{\mu}$ï¼›

    å¯¹äºåŒ…å«nä¸ªæ¶ˆè´¹è€…çš„å•é˜Ÿåˆ—å¤šæ¶ˆè´¹è€…ç³»ç»Ÿï¼Œå®šä¹‰ç³»ç»Ÿè´Ÿè½½$\rho=\frac{\lambda}{n\mu}$ã€‚

    å½“äºŒè€…ç³»ç»Ÿè´Ÿè½½ç›¸åŒæ—¶ï¼Œå°†åœ¨å•ä½æ—¶é—´å†…æ”¶åˆ°ç›¸åŒæ•°é‡çš„æ–°æ¶ˆæ¯ã€‚ä¸‹å›¾å±•ç¤ºäº†äºŒè€…åœ¨ç›¸åŒç³»ç»Ÿè´Ÿè½½æ—¶é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†çš„æ¶ˆæ¯æ€»æ•°å‡å€¼$L_q $ã€ç³»ç»Ÿæ¶ˆæ¯æ€»æ•°å‡å€¼$L$ã€æ¶ˆæ¯åœ¨ç³»ç»Ÿé€—ç•™æ—¶é—´å‡å€¼$W$ï¼Œå’Œæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´å‡å€¼$W_q$ï¼Œéšç³»ç»Ÿè´Ÿè½½$\rho$çš„å˜åŒ–å…³ç³»ã€‚

<img src=".\assets\mml.png" alt="L" style="zoom: 62%;" /><img src=".\assets\mmw.png" alt="W" style="zoom:62%;" />

* å¯è§å½“æ–°æ¶ˆæ¯åˆ°æ¥é€Ÿåº¦å°äºç³»ç»Ÿæ¶ˆæ¯æ¶ˆè´¹èƒ½åŠ›$\rho <1$çš„æ—¶å€™ï¼Œ`M/M/n`ç³»ç»Ÿèƒ½ç«‹å³å¤„ç†æ–°åˆ°æ¥æ¶ˆæ¯ï¼Œæ²¡æœ‰æ¶ˆæ¯ç§¯å‹ï¼Œä¹Ÿæ²¡æœ‰ç­‰å¾…å¤„ç†è€—æ—¶ã€‚ç„¶è€Œ==å•é˜Ÿåˆ—å•æ¶ˆè´¹è€…ç³»ç»Ÿç›¸è¾ƒäºå•é˜Ÿåˆ—å¤šæ¶ˆè´¹è€…ç³»ç»Ÿï¼Œæ¶ˆæ¯ç§¯å‹è¾ƒä¸ºä¸¥é‡ï¼Œæ¶ˆæ¯ç­‰å¾…å¤„ç†æ—¶é—´æ›´é•¿==ï¼Œåœ¨ç³»ç»Ÿè´Ÿè½½å¢å¤§æ—¶ï¼ŒåŠ£åŠ¿æ›´åŠ æ˜æ˜¾ã€‚

#### 4ï¼Œæ€§èƒ½ä¼˜åŒ–

* MQå‡ºäºæ¶ˆæ¯é¡ºåºæ€§æ¶ˆè´¹è€ƒè™‘ã€ä»¥åŠå•ä¸ªé˜Ÿåˆ—è¯»å†™æ€§èƒ½å—é™çš„åŸå› ï¼Œé»˜è®¤é™åˆ¶æ¯ä¸ªåˆ†åŒºåªèƒ½ç”±ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚
* `M/M/1`å’Œ`M/M/n`ç³»ç»Ÿæ€§èƒ½å·®è·ä¸»è¦æ¥æºäºï¼šç”±äºé˜Ÿåˆ—é—´ç‹¬ç«‹ï¼Œå¹¶ä¸”æ²¡æœ‰ç±»ä¼¼`Golang`ä¸­`GMP`çš„æ¶ˆæ¯çªƒå–æœºåˆ¶ï¼ˆåŒæ ·å‡ºäºæœ‰åºæ€§è¦æ±‚ï¼‰ï¼Œå½“ä¸€äº›é˜Ÿåˆ—é¢ä¸´é«˜å‹åŠ›å‡ºç°é•¿é˜Ÿåˆ—ï¼Œè€Œå…¶ä»–é˜Ÿåˆ—å¯èƒ½æš‚æ—¶ç©ºé—²ï¼Œç›¸åº”ç©ºé—²é˜Ÿåˆ—å¯¹åº”çš„æ¶ˆè´¹è€…ç©ºè½¬ï¼Œå¯¼è‡´ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡ä½ï¼Œæ¶ˆæ¯ä¸èƒ½åŠæ—¶å¤„ç†ã€‚
* MQçš„è§£å†³æ–¹å¼æ˜¯ä½¿ç”¨å†å¹³è¡¡æœºåˆ¶ï¼Œåœ¨æ¶ˆè´¹è€…ä¸é˜Ÿåˆ—ä¹‹é—´åŠ¨æ€åœ°é‡æ–°åˆ†é…é˜Ÿåˆ—æ¥å®ç°è´Ÿè½½å¹³è¡¡ã€‚å†å¹³è¡¡æœºåˆ¶å°†åœ¨å‘¨æœŸæ€§å»¶è¿Ÿã€æ¶ˆè´¹è€…å‘ç”Ÿå˜åŒ–ï¼Œä»¥åŠè®¢é˜…topicå˜åŒ–åï¼Œè¢«è§¦å‘æ‰§è¡Œå†å¹³è¡¡ã€‚

##### 4.1ï¼ŒRocketMQ å†å¹³è¡¡å®ç°

* Rocket MQä¸­åœ¨`RebalanceService#run()`ä¸­å®šæ—¶(é»˜è®¤20s)è§¦å‘å†å¹³è¡¡æµç¨‹ã€‚

    ```java
    // RebalanceService#run()
    public void run() {
        long realWaitInterval = waitInterval;
        while (!this.isStopped()) {
            // å®šæ—¶ä¼‘çœ åè§¦å‘å†å¹³è¡¡
            this.waitForRunning(realWaitInterval);
            boolean balanced = this.mqClientFactory.doRebalance();
            }
        }
    }
    ```

    å…·ä½“é€šè¿‡`RebalanceImpl`å®æ–½å¹³è¡¡ï¼šå†å¹³è¡¡è¿‡ç¨‹ä¸­ï¼Œè·å–å½“å‰æ‰€æœ‰æ´»è·ƒçš„æ¶ˆè´¹è€…åˆ—è¡¨å’Œæ‰€æœ‰é˜Ÿåˆ—çš„åˆ—è¡¨ï¼Œç„¶åæ ¹æ®è½®è¯¢æˆ–è€…ä¸€è‡´æ€§å“ˆå¸Œåˆ†é…ç­‰ç®—æ³•å°†topicä¸‹é˜Ÿåˆ—åˆ†é…ç»™æ‰€æœ‰æ´»è·ƒçš„æ¶ˆè´¹è€…ã€‚

    ```java
    // RebalanceImpl#doRebalance()
    public boolean doRebalance(final boolean isOrder) {
    	// è·å–å½“å‰æ‰€æœ‰æ´»è·ƒçš„æ¶ˆè´¹è€…åˆ—è¡¨å’Œæ‰€æœ‰é˜Ÿåˆ—çš„åˆ—è¡¨
        for (final Map.Entry<String, SubscriptionData> entry : subTable.entrySet()) {
            final String topic = entry.getKey();
            // æ‰§è¡Œå†å¹³è¡¡
            boolean result = this.rebalanceByTopic(topic, isOrder);
        }
    }
    ```

    ```java
    // RebalanceImpl#rebalanceByTopic
    private boolean rebalanceByTopic(final String topic, final boolean isOrder) {
        // è·å–topicå¯¹åº”çš„é˜Ÿåˆ—å’Œconsumerä¿¡æ¯
        Set<MessageQueue> mqSet = this.topicSubscribeInfoTable.get(topic);
        List<String> cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);
    	// é€‰æ‹©å†å¹³è¡¡ç­–ç•¥
        AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;
    	// å®Œæˆå†å¹³è¡¡
        List<MessageQueue> allocateResult = null;
        allocateResult = strategy.allocate(
            this.consumerGroup,
            this.mQClientFactory.getClientId(),
            mqAll,
            cidAll);
        }
    }
    ```

* å†å¹³è¡¡ç­–ç•¥å†³å®šé˜Ÿåˆ—å’Œæ¶ˆè´¹è€…é—´çš„å¯¹åº”å…³ç³»ï¼ŒRocketMQæä¾›äº†ä¸‹åˆ—åˆ†é…ç­–ç•¥

    * ` AllocateMessageQueueAveragely`ï¼šé»˜è®¤ç­–ç•¥ï¼Œå…ˆè®¡ç®—é˜Ÿåˆ—æ•°é™¤ä»¥æ¶ˆè´¹è€…æ•°çš„ä½™æ•°$N_q\%N_c=N_m$ï¼Œç„¶åå°†ä½™æ•°$N_m$ä¸ªé˜Ÿåˆ—ä¾æ¬¡åˆ†é…ç»™$N_m$ä¸ªæ¶ˆè´¹è€…ï¼Œæœ€åæŠŠå‰©ä½™çš„é˜Ÿåˆ—è¿ç»­çš„åˆ†ä¸º$(N_q-N_m)/N_c$ä»½ï¼Œä¾æ¬¡åˆ†é…ç»™å…¨éƒ¨æ¶ˆè´¹è€…ã€‚

    * `AllocateMessageQueueAveragelyByCircle`ï¼šæ¯ä¸ªæ¶ˆè´¹è€…ä¾æ¬¡åˆ†é…ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¾ªç¯åˆ†é…ï¼Œç›´è‡³åˆ†é…å®Œæ¯•å…¨éƒ¨é˜Ÿåˆ—ã€‚

    * `AllocateMessageQueueConsistentHash`ï¼šé€šè¿‡ä¸€è‡´æ€§hashç®—æ³•è®¡ç®—é˜Ÿåˆ—æ‰€å±æ¶ˆè´¹è€…ã€‚

##### 4.2ï¼ŒKafka å†å¹³è¡¡å®ç°

* å†å¹³è¡¡æµç¨‹å°†åœ¨æ¶ˆè´¹è€…ç»„æˆ–è€…topicå‘ç”Ÿå˜åŒ–åï¼Œå½“å‰æ¶ˆè´¹è€…ç»„é¢†å¯¼è€…åŠ å…¥æ¶ˆè´¹ç»„åè¿›è¡Œ

    ```java
    // ConsumerCoordinator#onJoinComplete
    protected void onJoinComplete(int generation, String memberId, String assignmentStrategy, ByteBuffer assignmentBuffer) {
        // å†å¹³è¡¡ç­–ç•¥
        ConsumerPartitionAssignor assignor = this.lookupAssignor(assignmentStrategy);
        // å¾…åˆ†é…åˆ†åŒº
        SortedSet<TopicPartition> assignedPartitions = new TreeSet(COMPARATOR);
        assignedPartitions.addAll(assignment.partitions());
        // æ‰§è¡Œåˆ†é…
        firstException.compareAndSet((Object)null, this.invokeOnAssignment(assignor, assignment));
        this.subscriptions.assignFromSubscribed(assignedPartitions);
        firstException.compareAndSet((Object)null, 	this.invokePartitionsAssigned(addedPartitions));
        }
    }
    ```

* å†å¹³è¡¡ç­–ç•¥ï¼šKafkaæä¾›äº†å’ŒRocketMQç›¸ä¼¼çš„åˆ†é…ç­–ç•¥
    * `RangeAssignor`ä¸`RocketMQ`çš„`AllocateMessageQueueAveragely`ç­–ç•¥ä¸€è‡´ã€‚
    * `RoundRobinAssignor`ä¸`RocketMQ`çš„`AllocateMessageQueueAveragelyByCircle`ç­–ç•¥ä¸€è‡´ã€‚
    * `StickyAssignor`ï¼šåˆ†é…å°½é‡å‡åŒ€ï¼Œå°½é‡ä¸ä¸Šä¸€æ¬¡åˆ†é…çš„ç›¸åŒï¼Œå°½é‡å‡å°‘åˆ†é…å…³ç³»çš„å˜åŠ¨ã€‚
    * `CooperativeStickyAssignor`ï¼šä¸¤é˜¶æ®µå†å¹³è¡¡ç­–ç•¥ï¼Œå…ˆå°è¯•åªç§»åŠ¨æœ€å°‘é‡çš„åˆ†åŒºå®Œæˆå†åˆ†é…ï¼Œå¦‚æœåˆ†é…åä¸æ»¡è¶³å¹³è¡¡æ¡ä»¶ï¼Œå†è¿›è¡Œå®Œæ•´çš„å†å¹³è¡¡ã€‚
    
    

#### å‚è€ƒ

[^1]: [M/M/1 queue]( https://zh.wikipedia.org/wiki/%E9%A9%AC%E5%B0%94%E5%8F%AF%E5%A4%AB%E9%93%BE) 
[^2]: [ç”Ÿç­è¿‡ç¨‹]( https://en.wikipedia.org/wiki/Birth%E2%80%93death_process) 
[^3]: [Little Law]( https://en.wikipedia.org/wiki/Little%27s_law) 
[^4]: [M/M/n queue]( https://en.wikipedia.org/wiki/M/M/c_queue) 